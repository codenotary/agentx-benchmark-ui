class g{static instance;db=null;initPromise=null;jsonicModule=null;constructor(){}static getInstance(){return g.instance||(g.instance=new g),g.instance}async initialize(){if(!this.db)return this.initPromise||(this.initPromise=this.performInitialization()),this.initPromise}async performInitialization(){const e=performance.now();console.log("[JSONIC] Starting initialization..."),console.log("[JSONIC] Environment:",{isDev:!1,baseUrl:"/agentx-benchmark-ui/",mode:"production",location:typeof window<"u"?window.location.href:"worker",userAgent:typeof navigator<"u"?navigator.userAgent:"unknown"});try{const t="/agentx-benchmark-ui/",n=typeof window>"u"&&typeof self<"u";let s;n?s="hybrid":s=new URLSearchParams(window.location.search).get("wrapper")||void 0||"hybrid";let a;n?a=`${t}jsonic-worker-wrapper.js`:s==="lightweight"||s==="v1"?(console.log("[JSONIC] Using LIGHTWEIGHT v1 wrapper for faster init"),a=`${t}jsonic-wrapper.esm.js`):s==="v3"?(console.log("[JSONIC] Using FULL v3.1 wrapper with all features"),a=`${t}jsonic-wrapper-v3.esm.js`):(console.log("[JSONIC] Using HYBRID wrapper (v4) - fast init + progressive features"),a=`${t}jsonic-hybrid/index.js`),console.log("[JSONIC] Loading wrapper from:",a),console.log("[JSONIC] Wrapper mode:",s),console.log("[JSONIC] Is Worker:",n);const r=performance.now(),d=await import(a);if(this.jsonicModule=d.default,console.log(`[JSONIC] Module loaded in ${(performance.now()-r).toFixed(2)}ms`),!this.jsonicModule)throw new Error("JSONIC module not found");let c;n?c="/agentx-benchmark-ui/jsonic_wasm_bg.wasm":c=typeof window<"u"&&window.location.pathname.startsWith("/agentx-benchmark-ui/")?"/agentx-benchmark-ui/jsonic_wasm_bg.wasm":`${t}jsonic_wasm_bg.wasm`;const i=performance.now(),o={wasmUrl:c,debug:!0,enablePersistence:!1,persistenceKey:"agentx_benchmark_db"};console.log("[JSONIC] Configuration:",o),console.log("[JSONIC] WASM URL:",c),(s==="v3"||s==="hybrid")&&(o.cacheSize=100,o.enableQueryCache=!0,o.enableBatchOptimization=!0,o.memoryLimit=100*1024*1024,o.indexHints={testId:"hash",timestamp:"btree",status:"hash",agentId:"hash",type:"hash"},s==="hybrid"&&(o.preloadFeatures=["cache","batch"])),this.jsonicModule.configure(o),console.log(`[JSONIC] Configuration completed in ${(performance.now()-i).toFixed(2)}ms`),console.log("JSONIC version:",this.jsonicModule.version),console.log("WASM URL:",c),console.log("Features: Query caching, Batch operations, Index optimization, OPFS persistence");const u=performance.now();this.db=await this.jsonicModule.createDatabase({enablePersistence:!1,persistenceKey:"agentx_benchmark_db",cacheSize:100,enableQueryCache:!0,enableBatchOptimization:!0,memoryLimit:100*1024*1024,indexHints:{testId:"hash",timestamp:"btree",status:"hash",agentId:"hash",type:"hash"},debug:!0}),console.log(`[JSONIC] Database created in ${(performance.now()-u).toFixed(2)}ms`),console.log("JSONIC v3.1 database initialized with performance optimizations");const h=performance.now(),p=await this.db.stats();console.log(`[JSONIC] Stats retrieved in ${(performance.now()-h).toFixed(2)}ms`),console.log("JSONIC stats:",p);const b=performance.now()-e;console.log(`[JSONIC] Total initialization time: ${b.toFixed(2)}ms`),b>1e3&&console.warn(`[JSONIC] ⚠️ Slow initialization detected: ${b.toFixed(2)}ms`)}catch(t){throw console.error("Failed to initialize JSONIC:",t),console.error(`[JSONIC] Failed after ${(performance.now()-e).toFixed(2)}ms`),t}}async getDatabase(){if(this.db||await this.initialize(),!this.db)throw new Error("JSONIC database not initialized");return this.db}async insert(e){return(await this.getDatabase()).insert(e)}async get(e){return(await this.getDatabase()).get(e)}async update(e,t){if(!await(await this.getDatabase()).update(e,t))throw new Error("Failed to update document")}async delete(e){if(!await(await this.getDatabase()).delete(e))throw new Error("Failed to delete document")}async listIds(){return(await this.getDatabase()).list()}async getStats(){return(await this.getDatabase()).stats()}async query(e){const t=await this.getDatabase(),n=await t.list(),s=[];for(const a of n){const r=await t.get(a);r&&r.content&&e(r.content)&&s.push({id:a,...r.content})}return s}async findDocuments(e,t){return(await this.getDatabase()).query(e,t)}async findOne(e){return(await this.getDatabase()).findOne(e)}find(e={}){const t=this.getDatabase(),n={sort:function(a){return this},limit:function(a){return this},skip:function(a){return this},project:function(a){return this},exec:async function(){return(await t).find(e).exec()},toArray:async function(){return(await t).find(e).toArray()},count:async function(){return(await t).find(e).count()}};let s={};return n.sort=a=>(s.sort=Object.entries(a).map(([r,d])=>[r,d]),n),n.limit=a=>(s.limit=a,n),n.skip=a=>(s.skip=a,n),n.project=a=>(s.projection=a,n),n.exec=async()=>(await t).query(e,s),n.toArray=async()=>(await t).query(e,s),n.count=async()=>(await t).find(e).count(),n}async insertMany(e){return(await this.getDatabase()).insertMany(e)}async updateMany(e,t){return(await this.getDatabase()).updateMany(e,t)}async deleteMany(e){return(await this.getDatabase()).deleteMany(e)}async aggregate(e){return(await this.getDatabase()).aggregate(e)}async getDebugInfo(){return(await this.getDatabase()).getDebugInfo()}async clearCache(){(await this.getDatabase()).clearCache()}async clearProfiler(){(await this.getDatabase()).clearProfiler()}async getBenchmarkStats(e){const t=[];return e&&t.push({$match:{testId:e}}),t.push({$group:{_id:"$testId",avgDuration:{$avg:"$duration"},minDuration:{$min:"$duration"},maxDuration:{$max:"$duration"},totalRuns:{$sum:1},successCount:{$sum:{$cond:[{$eq:["$status","success"]},1,0]}},failureCount:{$sum:{$cond:[{$eq:["$status","failure"]},1,0]}}}},{$sort:{totalRuns:-1}}),this.aggregate(t)}}const f=g.getInstance(),m=l=>{self.postMessage({type:"progress",payload:l})},w=async()=>{try{console.log("🔧 WORKER: Starting JSONIC migration..."),m({phase:"loading",current:0,total:100,message:"Loading data in background...",percentage:10});const l="/agentx-benchmark-ui/",e=new URL(`${l}data/database.json`,self.location.origin).href,t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch database.json: ${t.status}`);const n=await t.json(),s=(n.benchmark_runs?.length||0)+(n.model_performance?.length||0)+(n.test_results?.length||0)+(n.performance_trends?.length||0);console.log(`🔧 WORKER: Processing ${s} documents`),m({phase:"migrating",current:0,total:s,message:"Initializing JSONIC in worker...",percentage:15}),await f.initialize();let a=0;const r=50,d=async i=>{for(let o=0;o<i.length;o+=r){const u=i.slice(o,Math.min(o+r,i.length));await Promise.all(u.map(p=>f.insert(p))),a+=u.length;const h=20+a/s*70;m({phase:"migrating",current:a,total:s,message:`Processing documents... (${a}/${s})`,percentage:h})}},c=(i,o,u)=>({_type:i,_runId:u,_timestamp:new Date().toISOString(),...o});if(n.benchmark_runs){const i=n.benchmark_runs.map(o=>c("benchmark_run",o));await d(i),console.log(`🔧 WORKER: Migrated ${i.length} benchmark runs`)}if(n.model_performance){const i=n.model_performance.map(o=>c("model_performance",o,o.run_id));await d(i),console.log(`🔧 WORKER: Migrated ${i.length} model performance records`)}if(n.test_results){const i=n.test_results.map(o=>c("test_result",o,o.run_id));await d(i),console.log(`🔧 WORKER: Migrated ${i.length} test results`)}if(n.performance_trends){const i=n.performance_trends.map(o=>c("performance_trend",o));await d(i),console.log(`🔧 WORKER: Migrated ${i.length} performance trends`)}m({phase:"complete",current:s,total:s,message:`✅ Migration complete! ${s} documents processed.`,percentage:100}),console.log(`🎉 WORKER: Migration successful - ${s} documents`),self.postMessage({type:"migrationComplete",payload:!0})}catch(l){console.error("❌ WORKER: Migration failed:",l),m({phase:"error",current:0,total:100,message:l instanceof Error?l.message:"Unknown worker error",percentage:0}),self.postMessage({type:"migrationComplete",payload:!1})}};self.onmessage=l=>{l.data.type==="startMigration"&&w()};
//# sourceMappingURL=migration.worker-CFyk45tG.js.map
